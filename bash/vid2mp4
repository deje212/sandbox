#!/bin/bash

[ $# -lt 1 ] && { 
	echo "Usage: vid2mp4 <inputvideo>"; 
	exit 3; 
}

FILENAME="$1"

EXTRA_PARAMS="-map_metadata -1" # Retira metadados do vídeo destino.

VCODEC="$(ffprobe "$1" 2>&1 | sed -n '/Video:/s/^.\+Video: \(\w\+\),* \+.\+$/\1/p')"

# Usa preset do x264 com maior poder de análise.
if [ "$VCODEC" == "h264" ]; then
  VPARAMS="-c:v copy"
else
  VPARAMS="-c:v libx264 -qmax 23 -crf 17"
fi

ACODEC="$(ffprobe "$FILENAME" 2>&1 | sed -n '/Audio:/s/^.\+Audio: \(\w\+\),* \+.\+$/\1/p')"

if [ "$ACODEC" == "ac3" ]; then
  APARAMS="-c:a copy"
else
  ABR="$(ffprobe "$FILENAME" 2>&1 | sed -n '/Audio:/s/^.\+ \([0-9]\+\) kb\/s.\+$/\1/p')"
  if [ -z "$ABR" ]; then 
    echo "Cannot find audio bitrate. Using 128 kbps!"
    ABR=128
  fi

  if [ $ABR -le 64 ]; then ABR=64; else
    if [ $ABR -lt 96 ]; then ABR=64; else
      if [ $ABR -lt 128 ]; then ABR=96; else
        if [ $ABR -lt 160 ]; then ABR=128; else
          if [ $ABR -lt 192 ]; then ABR=160; else
            ABR=192;
          fi
        fi 
      fi 
    fi 
  fi

  APARAMS="-c:a ac3 -b:a ${ABR}k -ac 2"
fi

TMPFNAME="$(mktemp /tmp/tmp_XXXXXXXXXX.mp4)"
OFNAME="${FILENAME%.*}.mp4"

echo "FILENAME=\"$FILENAME\""
echo "TMPFNAME=\"$TMPFNAME\""

ffmpeg -y -i "$FILENAME" $VPARAMS $APARAMS $EXTRA_PARAMS $TMPFNAME && \
  rm "$FILENAME" && \
  mv "$TMPFNAME" "$OFNAME"
